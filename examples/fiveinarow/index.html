<!DOCTYPE html>
<html lang=en>

<head>
    <meta charset=utf-8 />
    <meta content="text/html; charset=utf-8" http-equiv=Content-Type />
    <title>Five in a row - Example game using GameBlocks.js</title>

    <style type="text/css">
        #container {
            width: 400px;
            height: 400px;
            overflow: hidden;

            border-top: 1px solid #aaa;
            border-left: 1px solid #aaa;
        }
        #container > div {
            width: 19px;
            height: 19px;
            line-height: 19px;
            text-align: center;
            cursor: pointer;
            float: left;

            border-bottom: 1px solid #aaa;
            border-right: 1px solid #aaa;
        }
        #container > div:hover {
            background: #eee;
        }
    </style>
</head>
<body>

<h1>Five in a row</h1>
<p>Two players, connect (at least) five in a row.</p>
<div id="container"></div>

<p>Built using <a href="https://github.com/shazow/gameblocks.js">gameblocks.js</a></p>

<script src="../../externs/Class.js"></script>
<script src="../../externs/unstdlib.js"></script>

<script src="../../src/Dom.js"></script>
<script src="../../src/Global.js"></script>

<script src="../../src/Camera.js"></script>
<script src="../../src/Clock.js"></script>
<script src="../../src/Engine.js"></script>
<script src="../../src/Entity.js"></script>
<script src="../../src/Input.js"></script>
<script src="../../src/Renderer.js"></script>
<script src="../../src/State.js"></script>

<script type="text/javascript">

    // Constants
    var WIDTH=20, HEIGHT=20, MAGNIFY=20;

    // Our game
    var container = Dom.select("#container");
    var input = new Game.Input();
    var state_machine = new Game.StateMachine();

    // We don't need a camera, renderer, or engine for this one.

    var Square = Class({
        pos: [],
        player: false,
        container: false,

        init: function(pos) {
            this.pos = pos;
            this.player = false;
            this.container = Dom.create("div");
            container.appendChild(this.container);
        }
    });

    var grid = unstdlib.make_grid([WIDTH, HEIGHT], function(pos) {
        return new Square(pos);
    });
    var grid_box = [0, 0, WIDTH-1, HEIGHT-1];

    var get_square = function(pos) {
        // ~~ is eqv to Math.floor, we -1 to account for the border
        // The grid is stored upside-down
        return grid[~~((pos[1]-1)/MAGNIFY)][~~((pos[0]-1)/MAGNIFY)];
    }

    var next_turn = unstdlib.Cycle(['x', 'o']);

    var find_line = function(pos, length) {
        var player = grid[pos[0]][pos[1]].player;
        length = length || 5;

        var directions = [[1,0], [0,1], [1,1], [-1,1]];
        for(var i=0, stop=directions.length; i<stop; i++) {
            var direction = directions[i];

            var line = [];
            var ipos = [pos[0] - direction[0] * length, pos[1] - direction[1] * length];

            for(var j=length*2; j>1; j--) {
                // TODO: Could quit early if line.length + j < length

                var ipos = [ipos[0] + direction[0], ipos[1] + direction[1]];

                if(!unstdlib.in_boundary(ipos, grid_box)) continue;

                var s = grid[ipos[0]][ipos[1]];
                if(s.player != player) {
                    if(line.length >= length) return line;

                    line = [];
                    continue;
                }

                line.push(ipos);
            }
            if(line.length >= length) return line;
        }

        return false;
    }

    state_machine.add(new Game.State('move', {
        'enter': function() {

            input.queue('MOUSE1', function() {
                state_machine.enter('process');
            });

        }
    }));
    state_machine.add(new Game.State('process', {
        'enter': function() {
            var square = get_square(input.mouse_pos);
            if(!square || square.player) return state_machine.enter('move');

            var player = next_turn();
            square.player = player
            square.container.innerText = player;

            var found_line = find_line(square.pos, 5);
            if(!found_line) {
                return state_machine.enter('move');
            }

            for(var i=0, stop=found_line.length; i<stop; i++) {
                var pos = found_line[i];
                var s = grid[pos[0]][pos[1]];
                s.container.innerText = s.player.toUpperCase();
                s.player = 'scored';
            }

            return state_machine.enter('move');
        }
    }));
    state_machine.enter('move'); // Start the state machine at the intro

    // Everything should be setup by now, time to start accepting customers
    input.mouse_start(container);

    // TODO: Add scores
    // TODO: Add support for more than 2 players
    // TODO: Add css-based tiles.

</script>

</body>

</html>
